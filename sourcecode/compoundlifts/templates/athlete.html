{% extends "base.html" %}
{% set active_page = "athletes" %}
{% block content %}
	<br />
	<div id="{{athlete._id}}" class="athlete no-padding container ">
		<br />
		<div class="cover-pic" style="background: url({{cover_pic|e}});">

		</div>
		
		<div>
			{% include 'includes/_messages.html' %}
			<div class="top">
				<div class="social">
					<img class="profile-pic" src='{{profile_pic|e}}' width=200px height=200px/>	
					<div class="follow">
						<div class="followers">
							<a id="follower-count" href="#" onclick="openTab('tab-followers-content');">{{athlete.followers | length}}</a>
							<p>Followers</p>
						</div>
						<div class="following">
							<a id="following-count" href="#" onclick="openTab('tab-following-content');">{{athlete.following | length}}</a>
							<p>Following</p>
						</div>
					</div>
					{% if current_user is not none and athlete._id != current_user._id %}
						{% if athlete._id|string in current_user.following %}
							<button class="unfollow-btn" type="submit" name="{{athlete._id|string}}"></button>
						{% else %}
							<button class="follow-btn" type="submit" name="{{athlete._id|string}}"></button>
						{% endif %}
					{% endif %}
				</div>
				<div class="split">
					<div class="breadcrumb">
						<p><a href="/">Home</a> > <a href="/athletes/">Athletes</a> > <a href="/athletes/{{athlete._id}}">{{athlete.first_name}} {{athlete.last_name}}</a></p>
					</div>
					<div class="info">
						<h1>{{athlete.first_name}} {{athlete.last_name}}</h1>
						<div class="tags">
							{% if user_profile.location_city|length > 1 %} 
								{% if user_profile.location_country|length > 1 %}
									<p>Location: {{user_profile.location_city}}, {{user_profile.location_country}}</p>
								{% else %}
									<p>Location: {{user_profile.location_city}}</p>
								{% endif %}
							{% elif user_profile.location_country|length > 1 %}
								<p>Location: {{user_profile.location_country}}</p>
							{% endif %}
							
							{% if user_profile.dob %}
								<p>Age: {{updated_age}}</p>
							{% endif %}

							{% if user_profile.weight %}
								<p>Weight: {{user_profile.weight}} KG</p>
							{% endif %}

							{% if user_profile.gender|length > 1 %}
								<p>Gender: {{user_profile.gender}}</p>
							{% endif %}
						</div>
						<div class="bio">
							{% if user_profile.profile_bio %}
								<p>{{user_profile.profile_bio}}</p>
							{% else %}
								<p>Default profile bio</p>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="athlete-tabs">
			<div id="tab-overview" class="tab active">
				<button id="btn-overview" onclick="openTab('tab-overview-content');">Overview</button>
			</div>
			<div id="tab-followers" class="tab">
				<button id="btn-followers" onclick="openTab('tab-followers-content');">Followers</button>
			</div>
			<div id="tab-following" class="tab">
				<button id="btn-following" onclick="openTab('tab-following-content');">Following</button>
			</div>
		</div>
		<div id="tab-overview-content" class="tab-content">
			{% if user_lifts is not none %}
			<div class="featured">
				<div class="title">
					<h1>LIFTS</h1>
				</div>
				<div class="cards">
					{% if deadlift_max is not none %}
						<div class="card">
							<img src="/static/resources/lifts/deadlift.jpg">
							<p class="weight">{{deadlift_max['weight']}} KG</p>
							<h2>DEADLIFT</h2>
						</div>
					{% endif %}
					{% if bench_max is not none %}
						<div class="card">
							<img src="/static/resources/lifts/bench.jpg">
							<p class="weight">{{bench_max['weight']}} KG</p>
							<h2>BENCH</h2>
						</div>
					{% endif %}
					{% if squat_max is not none %}
					<div class="card">
						<img src="/static/resources/lifts/squat2.jpg">
						<p class="weight">{{squat_max['weight']}}  KG</p>
						<h2>SQUAT</h2>
					</div>
					{% endif %}
				</div>
				{% if deadlift_max is not none %}
				<div id="deadlift" class="expanded-lift">
					<h1>Deadlift</h1>
					{% if user_lifts['lifts']['deadlift'] and user_lifts['lifts']['deadlift']|length > 0 %}
					{% for lift in user_lifts['lifts']['deadlift'] %}
					<div id="{{loop.index - 1}}" class="lift">						
						<div class="field">
							<div class="left">
								<div class="inline-headers">
									<h4 class="individual">WEIGHT: {{lift.weight}} KG</h4>
									<h4 class="individual">DATE: {{lift.date}}</h4>
								</div>
								
								<div class="description">
									<h4>DESCRIPTION:</h4>
									<p>{{lift.description}}</p>
								</div>
								<div class="video">
									{% if lift.video_url|length > 5 %}
										<iframe src="{{lift.embed_url}}" frameborder="0" allowfullscreen width="450" height="253" class="video"></iframe>
									{% else %}
										{#<img src="/static/resources/placeholder.jpg">#}
									{% endif %}
								</div>
							</div>
							<div class="right">
								<div class="comments scrollbar">
									<h4>COMMENTS ({{lift['comments']|length}}):</h4>
									{% if current_user is not none %}
										<div class="submit-comment">
											<form>
												<textarea id="deadlift-comment-{{loop.index -1}}" name="comment" placeholder="Write a comment here"></textarea>
											</form>
											<div class="inline-end">
												<p>Logged in as <a href="/athletes/{{session.id}}">{{session.fullname}}</a></p>
												<div class="submit-btn">
													<button class="btn btn-primary btn-submit-comment">SUBMIT</button>
												</div>
											</div>
																
										</div>
									{% else %}
										<div class="submit-comment">
											<p class="individual">You must be <a href="/login">logged in</a> to post a comment</p>
										</div>
									{% endif %}
									{% for comment in lift['comments'] %}
									<div data-commenter="{{comment.user_id}}" data-index="{{loop.index -1}}" class="comment">
										<div class="profile-pic">
											<a href="/athletes/{{comment.user_id}}"><img src="{{comment.profile_pic|e}}"></a>
										</div>
										<div class="content">
											<div class="basic-info">
												<p><a href="/athletes/{{comment.user_id}}">{{comment.full_name}}</a></p>
												<p>{{comment.comment}}</p>
												<textarea name="comment" placeholder="Write a comment here" style="display: none;"></textarea>
												<div class="inline">
													{% if current_user._id == comment.user_id or current_user._id == athlete._id %}
														<button class="btn-delete-comment">Delete</button>
													{% endif %}
													{#
													{% if current_user._id == comment.user_id or current_user.account_level == 10 %}
														<button class="btn-edit-comment">Edit</button>
														<button class="btn-edit-comment" style="display: none;">Cancel</button>
														<button class="btn-edit-comment" style="display: none;">Confirm</button>
													{% endif %}
													#}
													<p class="date">{{comment.date}}</p>
												</div>
											</div>
										</div>
									</div>
									{% endfor %}
									{% if lift['comments']|length < 1 %}

									{% endif %}
								</div>
							</div>
						</div>
					</div>
					{% endfor %}
					{% endif %}
				</div>
				{% endif %}
			</div>
			{% endif %}
		</div>
		<div id="tab-followers-content" class="tab-content" style="display: none;">
			<div class="no-padding container">
				{% include 'includes/_messages.html' %}
				{% include 'includes/_followers.html' %}
			</div>
		</div>
		<div id="tab-following-content" class="tab-content" style="display: none;">
			<div class="no-padding container">
				{% include 'includes/_messages.html' %}
				{% include 'includes/_following.html' %}
			</div>
		</div>
		<br />
	</div>
	<script>
		/*
		document.addEventListener("DOMContentLoaded", function(event) { 
			if (window.location.hash == "#followers")
			{
				openTab('tab-followers-content');
			}
			else if (window.location.hash == "#following")
			{
				openTab('tab-following-content');
			}
		}); */

		$(document).ready(function(){
			/*
			$('#btn-overview').on('click', function(){
				window.location.hash = '';
			});
			
			$('#btn-followers').on('click', function(){
				window.location.hash = 'followers';
				location.reload();
			});
			
			$('#btn-following').on('click', function(){
				window.location.hash = 'following';
				location.reload();
			});
			*/
			$(".btn-submit-comment").on('click', function(){
				var athlete_id = "{{athlete._id}}"
				var commenter_id = "{{current_user._id}}";
				var lift_type = $(this).closest('.expanded-lift').attr('id');
				var lift_index = $(this).closest('.lift').attr('id');
				var comment = $('#deadlift-comment-' + lift_index).val();
				console.log(commenter_id);
				data = {
					'athlete_id' : athlete_id,
					'commenter_id' : commenter_id,
					'comment' : comment,
					'lift_type' : lift_type,
					'lift_index' : lift_index
				};

				$.ajax({
					type : "POST",
					url : "/comment/add",
					data: JSON.stringify(data),
					contentType: 'application/json;charset=UTF-8',
					success: function(result) {
						console.log("New Comment: " + result);
					}
				});

				location.reload();
			});

			$(".btn-delete-comment").on('click', function(){
				var athlete_id = "{{athlete._id}}"
				var commenter_id = $(this).closest('.comment').data('commenter');
				var lift_type = $(this).closest('.expanded-lift').attr('id');
				var lift_index = $(this).closest('.lift').attr('id');
				var comment = $('#deadlift-comment-' + lift_index).val();
				var comment_index = $(this).closest('.comment').data('index');
				
				var comment_div = $(this).closest('.comment');
				
				data = {
					'athlete_id' : athlete_id,
					'commenter_id' : commenter_id,
					'comment_index' : comment_index,
					'comment' : comment,
					'lift_type' : lift_type,
					'lift_index' : lift_index,

				};
				
				$.ajax({
					type : "POST",
					url : "/comment/delete",
					data: JSON.stringify(data),
					contentType: 'application/json;charset=UTF-8',
					success: function(result) {
						console.log("Removed Comment: " + result);
						// Hide comment to remove without needing a page refresh
						comment_div.hide();
					}
				});
			});

			/*
			$(".btn-edit-comment").on('click', function(){
				var athlete_id = "{{athlete._id}}"
				var commenter_id = $(this).closest('.comment').data('commenter');
				var lift_type = $(this).closest('.expanded-lift').attr('id');
				var lift_index = $(this).closest('.lift').attr('id');
				var comment = $('#deadlift-comment-' + lift_index).val();
				var comment_index = $(this).closest('.comment').data('index');
				
				var comment_div = $(this).closest('.comment');
				
				data = {
					'athlete_id' : athlete_id,
					'commenter_id' : commenter_id,
					'comment_index' : comment_index,
					'comment' : comment,
					'lift_type' : lift_type,
					'lift_index' : lift_index,

				};
				
				$.ajax({
					type : "POST",
					url : "/comment/edit",
					data: JSON.stringify(data),
					contentType: 'application/json;charset=UTF-8',
					success: function(result) {
						console.log("Edited Comment: " + result);
						// Hide comment to remove without needing a page refresh
						comment_div.hide();
					}
				});
			});
			*/

			$("button.follow-btn").on('click', function(){
				var id = $(this).attr('name');

				if ( $(this).hasClass("follow-btn"))
				{
					$.ajax({
						type : "POST",
						url : "/follow/",
						data: id,
						contentType: 'application/json;charset=UTF-8',
						success: function(result) {
							console.log("Followed user: " + result);
						}
					});
					$('#follower-count').html(function(i, val) { return +val+1 });
					$(this).removeClass('follow-btn').addClass('unfollow-btn');
				}
				else
				{
					$.ajax({
						type : "POST",
						url : "/unfollow/",
						data: id,
						contentType: 'application/json;charset=UTF-8',
						success: function(result) {
							console.log("Unfollowed user: " + result);
						}
					});
					$('#follower-count').html(function(i, val) { return +val-1 });
					$(this).removeClass('unfollow-btn').addClass('follow-btn');
				}
			});

			$("button.unfollow-btn").on('click', function(){
				var id = $(this).attr('name');
				
				if ( $(this).hasClass("unfollow-btn"))
				{
					$.ajax({
						type : "POST",
						url : "/unfollow/",
						data: id,
						contentType: 'application/json;charset=UTF-8',
						success: function(result) {
							console.log("Unfollowed user: " + result);
						}
					});
					$('#follower-count').html(function(i, val) { return +val-1 });
					$(this).removeClass('unfollow-btn').addClass('follow-btn');
				}
				else
				{
					$.ajax({
						type : "POST",
						url : "/follow/",
						data: id,
						contentType: 'application/json;charset=UTF-8',
						success: function(result) {
							console.log("Followed user: " + result);
						}
					});
					$('#follower-count').html(function(i, val) { return +val+1 });
					$(this).removeClass('follow-btn').addClass('unfollow-btn');
				}
			});
		});
	</script>
{% endblock %}
